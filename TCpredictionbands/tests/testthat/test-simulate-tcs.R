# Test TC curve simulation: pulling data -> fitting models -> generating curves

context("TC Simulation test")

library(TCpredictionbands)

# Training TC names ----------------
train_names <- 
  c("AL041951", "AL051951", "AL061951", "AL091951", "AL021951", "AL071951",
    "AL101951", "AL121951", "AL071952", "AL011952", "AL021952", 
    "AL091952", "AL051952", "AL031952", "AL041952", "AL081952", "AL111953", 
    "AL131953", "AL051953", "AL091953", "AL101953", "AL021953", "AL061953", 
    "AL011953", "AL141953", "AL081953", "AL011954", "AL061954", "AL131954", 
    "AL051954", "AL151954", "AL071954", "AL141954", "AL021954", "AL111954", 
    "AL101954", "AL081954", "AL021955", "AL091955", "AL051955", "AL121955", 
    "AL061955", "AL071955", "AL041955", "AL081955", "AL101955", "AL011956", 
    "AL061956", "AL081956", "AL071956", "AL041956", "AL091956", "AL031956", 
    "AL021956", "AL011957", "AL081957", "AL021957", "AL031957", "AL051957", 
    "AL061957", "AL111958", "AL041958", "AL051958", "AL031958", "AL061958", 
    "AL021958", "AL091958", "AL121958", "AL021959", "AL121959", "AL051959", 
    "AL101959", "AL041959", "AL111959", "AL091959", "AL071959", "AL061959", 
    "AL141959", "AL071960", "AL081960", "AL031960", "AL041960", "AL021960", 
    "AL011960", "AL091961", "AL031961", "AL071961", "AL011961", "AL021961", 
    "AL081961", "AL111961", "AL061961", "AL041962", "AL051962", "AL031962", 
    "AL021962", "AL051963", "AL041963", "AL061963", "AL081963", "AL071963", 
    "AL021963", "AL041964", "AL111964", "AL071964", "AL021964", "AL091964", 
    "AL121964", "AL061964", "AL031964", "AL061965", "AL041965", "AL021965", 
    "AL051965", "AL021966", "AL011966", "AL071966", "AL101966", "AL051966", 
    "AL091966", "AL041966", "AL111966", "AL131967", "AL051967", "AL191967", 
    "AL111967", "AL121967", "AL251967", "AL211967", "AL221967", "AL231967", 
    "AL021967", "AL011967", "AL101967", "AL141967", "AL081967", "AL071967", 
    "AL061967", "AL151967", "AL201967", "AL111968", "AL091968", "AL041968", 
    "AL131968", "AL141968", "AL051968", "AL021968", "AL061968", "AL011968", 
    "AL081968", "AL181969", "AL161969", "AL091969", "AL121969", "AL131969", 
    "AL051969", "AL251969", "AL021969", "AL061969", "AL241969", "AL211969", 
    "AL171969", "AL081969", "AL231969", "AL141969", "AL191969", "AL011969", 
    "AL201969", "AL291969", "AL041969", "AL121970", "AL161970", "AL151970", 
    "AL071970", "AL061970", "AL131970", "AL091970", "AL141970", "AL181970", 
    "AL101970", "AL031970", "AL021970", "AL111970", "AL121971", "AL191971", 
    "AL041971", "AL151971", "AL141971", "AL171971", "AL091971", "AL111971", 
    "AL061971", "AL021971", "AL221971", "AL201971", "AL181971", "AL011971", 
    "AL071971", "AL071972", "AL151972", "AL051972", "AL041972", "AL081972", 
    "AL161972", "AL031972", "AL191972", "AL121972", "AL021972", "AL131972", 
    "AL061972", "AL111972", "AL021973", "AL131973", "AL151973", "AL121973", 
    "AL051973", "AL081973", "AL111973", "AL101973", "AL041973", "AL031973", 
    "AL171973", "AL071973", "AL111974", "AL181974", "AL101974", "AL051974", 
    "AL011974", "AL071974", "AL121974", "AL171974", "AL021974", "AL131974", 
    "AL151974", "AL041974", "AL061974", "AL201974", "AL131975", "AL101975", 
    "AL221975", "AL071975", "AL111975", "AL171975", "AL031975", "AL201975", 
    "AL041975", "AL161975", "AL021975", "AL061975", "AL191975", "AL081975", 
    "AL091975", "AL151975", "AL131976", "AL101976", "AL031976", "AL051976", 
    "AL091976", "AL061976", "AL151976", "AL081976", "AL181976", "AL041976", 
    "AL171976", "AL141976", "AL021976", "AL011976", "AL161976", "AL101977", 
    "AL031977", "AL011977", "AL021977", "AL051977", "AL121977", "AL141977", 
    "AL151977", "AL081977", "AL071977", "AL121978", "AL181978", "AL011978", 
    "AL241978", "AL231978", "AL081978", "AL221978", "AL031978", "AL061978", 
    "AL171978", "AL021978", "AL151978", "AL131978", "AL141978", "AL101978", 
    "AL211978", "AL051978", "AL141979", "AL021979", "AL031979", "AL011979", 
    "AL151979", "AL111979", "AL191979", "AL071979", "AL061979", "AL051979", 
    "AL101979", "AL201979", "AL131979", "AL171979", "AL081980", "AL031980", 
    "AL041980", "AL131980", "AL111980", "AL161980", "AL061980", "AL011980", 
    "AL151980", "AL091980", "AL051980", "AL181980", "AL021980", "AL091981", 
    "AL211981", "AL181981", "AL191981", "AL151981", "AL141981", "AL051981", 
    "AL121981", "AL171981", "AL041981", "AL161981", "AL221981", "AL011981", 
    "AL131981", "AL111981", "AL021982", "AL051982", "AL061982", "AL071982", 
    "AL011982", "AL081982", "AL031983", "AL041983", "AL021983", "AL051983", 
    "AL041984", "AL081984", "AL141984", "AL091984", "AL021984", "AL121984", 
    "AL061984", "AL131984", "AL201984", "AL101984", "AL011984", "AL191984", 
    "AL151984", "AL111984", "AL051985", "AL111985", "AL041985", "AL071985", 
    "AL091985", "AL011985", "AL061985", "AL141985", "AL031985", "AL081985", 
    "AL061986", "AL091986", "AL021986", "AL081986", "AL031986", "AL071986", 
    "AL041986", "AL021987", "AL071987", "AL061987", "AL131987", "AL111987", 
    "AL091987", "AL031987", "AL081987", "AL051987", "AL121987", "AL031988", 
    "AL181988", "AL191988", "AL171988", "AL141988", "AL081988", "AL161988", 
    "AL051988", "AL151988", "AL041988", "AL101988", "AL021988", "AL121988", 
    "AL031989", "AL141989", "AL121989", "AL131989", "AL081989", "AL041989", 
    "AL111989", "AL011989", "AL071989", "AL061989", "AL051990", "AL121990", 
    "AL151990", "AL101990", "AL161990", "AL141990", "AL041990", "AL071990", 
    "AL091990", "AL131990", "AL081990", "AL081991", "AL021991", "AL041991", 
    "AL101991", "AL011991", "AL071991", "AL061991", "AL051991", "AL101992", 
    "AL011992", "AL041992", "AL081992", "AL091992", "AL051992", "AL031992", 
    "AL011993", "AL051993", "AL081993", "AL101993", "AL021993", "AL031993", 
    "AL091993", "AL041994", "AL051994", "AL121994", "AL091994", "AL011994", 
    "AL081994", "AL061994", "AL031994", "AL081995", "AL041995", "AL021995", 
    "AL121995", "AL101995", "AL161995", "AL171995", "AL011995", "AL031995", 
    "AL061995", "AL141995", "AL051995", "AL131995", "AL211995", "AL181995", 
    "AL031996", "AL061996", "AL081996", "AL051996", "AL091996", "AL121996", 
    "AL131996", "AL011996", "AL021996", "AL081997", "AL041997", "AL091997", 
    "AL051997", "AL071997", "AL011997", "AL121998", "AL131998", "AL081998", 
    "AL061998", "AL021998", "AL011998", "AL141998", "AL091998", "AL071998", 
    "AL051998", "AL051999", "AL031999", "AL061999", "AL141999", "AL131999", 
    "AL121999", "AL091999", "AL011999", "AL161999", "AL081999", "AL041999", 
    "AL132000", "AL092000", "AL172000", "AL072000", "AL192000", "AL112000", 
    "AL162000", "AL142000", "AL062000", "AL012000", "AL152000", "AL122000", 
    "AL022000", "AL112001", "AL092001", "AL062001", "AL162001", "AL172001", 
    "AL142001", "AL042001", "AL022001", "AL132001", "AL082001", "AL152001", 
    "AL052001", "AL142002", "AL132002", "AL082002", "AL012002", "AL042002", 
    "AL032002", "AL112002", "AL122002", "AL092002", "AL022002", "AL042003", 
    "AL132003", "AL082003", "AL182003", "AL122003", "AL062003", "AL032003", 
    "AL022003", "AL202003", "AL052003", "AL072003", "AL192003", "AL102003", 
    "AL172003", "AL012003", "AL152004", "AL122004", "AL062004", "AL022004", 
    "AL012004", "AL102004", "AL092004", "AL142004", "AL132004", "AL032004", 
    "AL052004", "AL292005", "AL212005", "AL082005", "AL192005", "AL312005", 
    "AL252005", "AL042005", "AL112005", "AL062005", "AL032005", "AL182005", 
    "AL242005", "AL132005", "AL272005", "AL152005", "AL122005", "AL232005", 
    "AL142005", "AL092005", "AL012005", "AL072005", "AL052005", "AL012006", 
    "AL052006", "AL082006", "AL092006", "AL042006", "AL022006", "AL062006", 
    "AL122007", "AL142007", "AL102007", "AL072007", "AL162007", "AL052007", 
    "AL172007", "AL092007", "AL152007", "AL022007", "AL062007", "AL132007", 
    "AL172008", "AL062008", "AL162008", "AL142008", "AL022008", "AL122008", 
    "AL042008", "AL152008", "AL052008", "AL102008", "AL032008", "AL012008", 
    "AL042009", "AL072009", "AL012009", "AL102009", "AL022009", "AL112009", 
    "AL092009", "AL082009", "AL142010", "AL062010", "AL132010", "AL092010", 
    "AL162010", "AL212010", "AL202010", "AL052010", "AL112010", "AL152010", 
    "AL042010", "AL012010", "AL102010", "AL122010", "AL172010", "AL182011", 
    "AL062011", "AL162011", "AL042011", "AL202011", "AL172011", "AL012011", 
    "AL122011", "AL092011", "AL112011", "AL072011", "AL082011", "AL032011", 
    "AL152011", "AL112012", "AL022012", "AL042012", "AL102012", "AL122012", 
    "AL132012", "AL052012", "AL162012", "AL012012", "AL072012", "AL172012", 
    "AL142012", "AL152012", "AL032013", "AL062013", "AL092013", "AL102013", 
    "AL142013", "AL132013", "AL052013", "AL122013", "AL152013", "AL072013", 
    "AL022014", "AL032014", "AL092014", "AL052014", "AL042014", "AL012014", 
    "AL072015", "AL122015", "AL062015", "AL042015", "AL092015", "AL012015", 
    "AL102015", "AL112015", "AL092016", "AL132016", "AL162016", "AL062016", 
    "AL072016", "AL142016", "AL022016", "AL112016", "AL042016", "AL122016", 
    "AL152016")

# Test TC names ----------------
test_names <- c("AL011951", "AL031951", "AL081951", "AL111951", "AL061952", 
    "AL101952", "AL111952", "AL031953", "AL041953", "AL071953", "AL121953", 
    "AL031954", "AL041954", "AL091954", "AL121954", "AL161954", "AL011955", 
    "AL031955", "AL111955", "AL131955", "AL051956", "AL101956", "AL111956", 
    "AL121956", "AL041957", "AL071957", "AL011958", "AL071958", "AL081958", 
    "AL101958", "AL011959", "AL031959", "AL081959", "AL131959", "AL051960", 
    "AL061960", "AL041961", "AL051961", "AL101961", "AL011962", "AL011963", 
    "AL031963", "AL091963", "AL011964", "AL051964", "AL081964", "AL101964", 
    "AL011965", "AL031965", "AL031966", "AL061966", "AL081966", "AL031967",
    "AL041967", "AL091967", "AL161967", "AL171967", "AL181967", "AL241967", 
    "AL261967", "AL031968", "AL071968", "AL101968", "AL121968", "AL151968", 
    "AL031969", "AL071969", "AL101969", "AL111969", "AL151969", "AL221969", 
    "AL261969", "AL271969", "AL281969", "AL011970", "AL041970", "AL051970", 
    "AL081970", "AL171970", "AL191970", "AL031971", "AL051971", "AL081971", 
    "AL101971", "AL131971", "AL161971", "AL211971", "AL011972", "AL091972", 
    "AL101972", "AL141972", "AL171972", "AL181972", "AL011973", "AL061973", 
    "AL091973", "AL141973", "AL161973", "AL031974", "AL081974", "AL091974", 
    "AL141974", "AL161974", "AL191974", "AL011975", "AL051975", "AL121975", 
    "AL141975", "AL181975", "AL211975", "AL231975", "AL071976", "AL111976", 
    "AL121976", "AL191976", "AL201976", "AL211976", "AL041977", "AL061977", 
    "AL091977", "AL111977", "AL131977", "AL041978", "AL071978", "AL091978", 
    "AL111978", "AL161978", "AL191978", "AL201978", "AL041979", "AL081979", 
    "AL091979", "AL121979", "AL161979", "AL181979", "AL071980", "AL101980", 
    "AL121980", "AL141980", "AL171980", "AL021981", "AL031981", "AL061981", 
    "AL071981", "AL081981", "AL101981", "AL201981", "AL031982", "AL041982", 
    "AL011983", "AL061983", "AL031984", "AL051984", "AL071984", "AL161984", 
    "AL171984", "AL181984", "AL021985", "AL101985", "AL121985", "AL131985", 
    "AL011986", "AL051986", "AL101986", "AL011987", "AL041987", "AL101987", 
    "AL141987", "AL011988", "AL061988", "AL071988", "AL091988", "AL111988", 
    "AL131988", "AL021989", "AL051989", "AL091989", "AL101989", "AL151989", 
    "AL011990", "AL021990", "AL031990", "AL061990", "AL111990", "AL031991", 
    "AL091991", "AL111991", "AL121991", "AL021992", "AL061992", "AL071992", 
    "AL041993", "AL061993", "AL071993", "AL021994", "AL071994", "AL101994", 
    "AL111994", "AL071995", "AL091995", "AL111995", "AL151995", "AL191995", 
    "AL201995", "AL041996", "AL071996", "AL101996", "AL111996", "AL021997", 
    "AL031997", "AL061997", "AL031998", "AL041998", "AL101998", "AL111998", 
    "AL021999", "AL071999", "AL101999", "AL111999", "AL151999", "AL032000", 
    "AL042000", "AL052000", "AL082000", "AL102000", "AL182000", "AL012001", 
    "AL032001", "AL072001", "AL102001", "AL122001", "AL052002", "AL062002", 
    "AL072002", "AL102002", "AL092003", "AL112003", "AL142003", "AL152003", 
    "AL162003", "AL212003", "AL042004", "AL072004", "AL082004", "AL112004", 
    "AL162004", "AL022005", "AL102005", "AL162005", "AL172005", "AL202005", 
    "AL222005", "AL262005", "AL282005", "AL302005", "AL032006", "AL072006", 
    "AL102006", "AL012007", "AL032007", "AL042007", "AL082007", "AL112007", 
    "AL072008", "AL082008", "AL092008", "AL112008", "AL132008", "AL032009", 
    "AL052009", "AL062009", "AL022010", "AL032010", "AL072010", "AL082010", 
    "AL182010", "AL192010", "AL022011", "AL052011", "AL102011", "AL132011", 
    "AL142011", "AL192011", "AL032012", "AL062012", "AL082012", "AL092012", 
    "AL182012", "AL192012", "AL012013", "AL022013", "AL042013", "AL082013", 
    "AL112013", "AL062014", "AL072014", "AL082014", "AL022015", "AL032015", 
    "AL052015", "AL082015", "AL012016", "AL032016", "AL052016", "AL082016", 
    "AL102016")

# Read in data from HURDAT ----------------
set.seed(87)
tc_list <- TCpredictionbands::pull_data()

# Get training and test TC data ----------------
train <- tc_list[train_names]
test <- tc_list[test_names]

# Train models on training data ----------------
train_models <- TCpredictionbands::get_train_models(train)

# Simulate paths for test TC "AL032009" ----------------

# Set TC and number of paths to simulate
test_tc <- vector("list", 1)
test_tc[[1]] <- test[["AL032009"]]
number_paths <- 2
  
# Create empty list of length 4 to store simulations for individual TC
sim_setup <- vector("list", 4)
names(sim_setup) <- c("Auto_DeathRegs", "Auto_NoDeathRegs", 
                      "NoAuto_DeathRegs", "NoAuto_NoDeathRegs")

# Create list to store test simulations for all TCs
test_sims <- vector("list", 1)

# Name test_sims after test TC
names(test_sims) <- "AL032009"
  
# Set each element of test_sims (only 1 element) equal to sim_setup
test_sims <- lapply(test_sims, FUN = function(x) x = sim_setup)
  
# MAIN LOOP for auto/non-auto and speed/non-speed combos
tf <- c(T, F)

# Loop to generate AR / non-AR and death reg / no death reg simulated TCs
for (auto_ind in tf) {
    
  # Store starting points and set up regression variables
  # auto = F requires first two rows to get initial change in bearing/speed
  # auto = T requires first three rows to get initial change in lag 
  #        bearing/speed
  starts <- TCpredictionbands::get_starting_points(test_tc, auto = auto_ind)
    
  # Loop over whether logistic regressions are used to model lysis (death)
  for (death_regs_ind in tf) {
    
    # Set index for storage of simulations based on parameters.
    # Set up progress bar if verbose = T.
    if (auto_ind & death_regs_ind) {
        param_index <- 1
    } else if (auto_ind & !death_regs_ind) {
        param_index <- 2
    } else if (!auto_ind & death_regs_ind) {
        param_index <- 3
    } else if (!auto_ind & !death_regs_ind) {
        param_index <- 4
    }

    # Empty list of length number_paths, to make number_paths curves
    paths <- vector("list", number_paths)

    # Get starting observations for all test TCs
    paths <- lapply(paths, FUN = function(x) return(starts[[1]]))
      
    # Generate number_paths curves from starting observations
    paths <- lapply(paths, 
                    FUN = function(path)
                      TCpredictionbands::generate_curve(path, train_models,
                                                    death_regs_ind, auto_ind))
      
    # Round to closest tenth to match NOAA format
    paths <- lapply(paths, FUN = function(x) TCpredictionbands::round_curve(x))
      
    # Set column names
    paths <- lapply(paths, FUN = function(x) {
                                      colnames(x) = c("long", "lat"); x})

    # Store simulations in test_sims
    test_sims[["AL032009"]][[param_index]] <- paths
      
  }
}

# Obtaining the stored simulations
internal_data <- TCpredictionbands:::internal_data
stored_test_sims <- internal_data[["test_sims"]]


# Test that new test_sims and stored_test_sims are the same
test_that("Checking the simulated TC results have not changed", {
  expect_identical(test_sims, stored_test_sims)
})

