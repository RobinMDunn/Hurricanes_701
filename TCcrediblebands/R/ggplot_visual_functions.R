# Basic visualization functions -----------------------


#' Format curves from a list to a single data.frame
#'
#' @param test_list list of curves
#' @param c_position position of lat and lon columns in the test_list dataframes
#'
#' @return single data frame with all curves (curve column with idx of curve)
#' @export
#'
data_plot_paths_basic <- function(test_list, c_position = 1:2) {
  
  data_out <- data.frame(lat = -360,
                         long = -360,
                         curve = 0)
  
  for (i in 1:length(test_list)) {
    data_out <- rbind(data_out,
                      data.frame(
                        lat = test_list[[i]][, c_position[2]],
                        long = test_list[[i]][, c_position[1]],
                        curve = i
                      ))
  }
  data_out <- data_out[-1, ]
  
  return(data_out)
  
}

#' Visualize TC Paths (with ggplot)
#'
#' Note / TODO: 
#' Function currently uses geom_path - assumed euclidean space for map :/
#'
#' @param data_out data frame with correct path information same as outputed 
#'       from data_plot_sc_paths functions
#' @param zoom map zoom for ggmap
#' @param base_graph ggplot object for base graph 
#'       (created from data_out otherwise)
#' @param alpha opacity of curves 
#'
#' @return ggplot visualisation of the curve
#' @export
ggvis_paths <- function(data_out, zoom = 4,
                        base_graph = NULL, alpha = .01){
  if (is.null(base_graph)) {
    latrange <- range(data_out$lat)
    lonrange <- range(data_out$long)
    
    ocean <- c(left = lonrange[1], bottom = latrange[1],
               right = lonrange[2], top = latrange[2])
    map   <- ggmap::get_stamenmap(ocean, zoom = zoom, maptype = "toner-lite")
    
    base_graph <- ggmap::ggmap(map)
  } 
  
  # final map ---------------
  ggout <- base_graph + ggplot2::geom_path(data = data_out, 
                                  ggplot2::aes_string(x = 'long', y = 'lat', group = 'curve'),
                                  alpha = alpha) 
  
  return(ggout)
}


# KDE contour visualization functions -----------------------

#' Title
#'
#' @param contour_list unnamed list of contour elements, of 
#' \itemize{
#' \item level The contour level.
#' \item x The x-coordinates of the contour.
#' \item y The y-coordinates of the contour.
#' }
#' 
#' This list has the same format as the \code{contour} element generated by
#' \code{\link{kde_from_tclist}}
#'
#' @return a list of data frames (\code{x}, \code{y}, and \code{level} columns)
#' @export
contour_list_to_df <- function(contour_list){
  contour_list_of_df <- list()
  for (i in 1:length(contour_list)) {
    contour_list_of_df[[i]] <- data.frame(x = contour_list[[i]]$x,
                                     y = contour_list[[i]]$y,
                                     level = contour_list[[i]]$level
    )
  }
  return(contour_list_of_df)
}



#' Create ggplot of contour
#' 
#' @param level_contour_list list of  data frame of level contours
#' @param base_graph ggplot object for base graph 
#'       (created from data_out otherwise)
#' @param zoom map zoom for ggmap
#' @param color color of band
#' @param ... interior ggpath parameters
#'
#' @return ggplot object of contour and data points.
#' @export
ggvis_kde_contour <- function(level_contour_list, base_graph = NULL,
                              zoom = 4, color = "pink", ...){
  
  if (is.null(base_graph)) {
    latrange <- range(sapply(level_contour_list, function(df){
                              range(df$y)}))
    lonrange <- range(sapply(level_contour_list, function(df){
      range(df$x)}))
    ocean <- c(left = lonrange[1], bottom = latrange[1],
               right = lonrange[2], top = latrange[2])
    map   <- ggmap::get_stamenmap(ocean, zoom = zoom, maptype = "toner-lite")
    
    base_graph <- ggmap::ggmap(map)
  } 
  
  ggout <- base_graph  
  for (i in 1:length(level_contour_list)) {
    ggout <- ggout + 
      ggplot2::geom_path(data = level_contour_list[[i]],
                         ggplot2::aes_string(x = "x", y = "y"),
                         color = color)
  }
  return(ggout)
}


# Delta Ball Visualization function ------------------------

#' Visualize delta ball exterior centers (with ggplot)
#'
#' @param output_lines data frame of exterior lines (not ordered)
#' @param base_graph ggplot object for base graph 
#'       (created from output_lines otherwise)
#' @param zoom map zoom for ggmap
#' @param color color of band
#' @param ... interior ggpath parameters
#'
#' @return ggplot object of contours
#' @export
#'
ggvis_delta_ball_contour <- function(output_lines, base_graph = NULL, zoom = 4,
                                     color = "pink", ...){
  if (is.null(base_graph)) {
    latrange <- range(output_lines$lat)
    lonrange <- range(output_lines$lon)
    
    ocean <- c(left = lonrange[1], bottom = latrange[1],
               right = lonrange[2], top = latrange[2])
    map   <- ggmap::get_stamenmap(ocean, zoom = zoom, maptype = "toner-lite")
    
    base_graph <- ggmap::ggmap(map)
  } 
  
  ggout <- base_graph + 
    ggplot2::geom_line(data = output_lines, 
                       ggplot2::aes_string(x = 'lat', y = 'lon', group = 'idx'),
                       color = color, ...)
  
  return(ggout)
}

# Convex Hull visualation function ---------------------------


#' Visualize delta ball exterior centers (with ggplot)
#'
#' @description 
#' Basically the same of \code{\link{ggvis_delta_ball_contour}}
#'
#' @param output_lines data frame of exterior lines
#' @param base_graph ggplot object for base graph 
#'       (created from output_lines otherwise)
#' @param zoom map zoom for ggmap
#' @param color color of band
#' @param ... interior ggpath parameters
#'
#' @return ggplot object of contour
#' @export
#'
ggvis_convex_hull <- function(output_lines, base_graph = NULL, zoom = 4,
                                     color = "pink", ...){
  
  names(output_lines)[names(output_lines) == "long"] <- "lon"
  
  if (is.null(base_graph)) {
    latrange <- range(output_lines$lat)
    lonrange <- range(output_lines$lon)
    
    ocean <- c(left = lonrange[1], bottom = latrange[1],
               right = lonrange[2], top = latrange[2])
    map   <- ggmap::get_stamenmap(ocean, zoom = zoom, maptype = "toner-lite")
    
    base_graph <- ggmap::ggmap(map)
  } 
  
  ggout <- base_graph + 
    ggplot2::geom_path(data = output_lines, 
                       ggplot2::aes_string(x = 'lat', y = 'lon'),
                       color = color, ...)
  
  return(ggout)
}


# Bubble visualization functions -------------------------


#' Plot lines for bubble data 
#'
#' @param bubble_plot_data list of center points, positive and negative 
#' tangential points 
#' (each a n x 2 data frame)
#' @param base_graph plot to add to
#' @param centers boolean to decide whether to also plot centers (as points)
#' @param connect boolean to connect the left and right final tangential points
#' @param color color of band
#' @param linewidth width of line
#' @param zoom map zoom for ggmap
#' @param ... Interior ggpath parameters
#'
#' @return ggplot object with curves on it
#' @export
#'
ggvis_bubble_data <- function(bubble_plot_data, base_graph = NULL,
                              centers = FALSE, connect = TRUE,
                              color = "pink", linewidth = 1, zoom = 4,
                              ...){
  data_plot_lower <- data.frame(bubble_plot_data$positive)
  names(data_plot_lower)[1:2] <- c("lat", "lon")
  data_plot_upper <- data.frame(bubble_plot_data$negative)
  names(data_plot_upper)[1:2] <- c("lat", "lon")
  
  if (is.null(base_graph)) {
    
    data_all <- rbind(data_plot_lower, data_plot_upper)
    latrange <- range(data_all$lat)
    lonrange <- range(data_all$lon)
    
    ocean <- c(left = lonrange[1], bottom = latrange[1],
               right = lonrange[2], top = latrange[2])
    map   <- ggmap::get_stamenmap(ocean, zoom = zoom, maptype = "toner-lite")
    
    base_graph <- ggmap::ggmap(map)
    
  } 
  
  ggout <- base_graph + 
    ggplot2::geom_path(data = data_plot_lower, ggplot2::aes_string(x = 'lat', y = 'lon'), 
              color = color, size = linewidth, ...) +
    ggplot2::geom_path(data = data_plot_upper, ggplot2::aes_string(x = 'lat', y = 'lon'), 
              color = color, size = linewidth, ...) 
  
  if (centers) {
    ggout <- ggvis_bubble_data_centers_inner(bubble_plot_data, base_graph = ggout, 
                              color = color, zoom = 4, ...)
  }
  
  if (connect) {
    n_final <- nrow(data_plot_lower)
    ggout <- ggout + ggplot2::geom_segment(data = 
                            data.frame(x = data_plot_lower[n_final,"lat"],
                                       y = data_plot_lower[n_final,"lon"],
                                       xend = data_plot_upper[n_final,"lat"],
                                       yend = data_plot_upper[n_final,"lon"]),
                            ggplot2::aes_string(x = "x",
                                                y = "y",
                                                xend = "xend",
                                                yend = "yend"),
                            color = color, size = linewidth)
  }
  
  return(ggout)
}


#' Inner Plot centers for bubble data
#'
#' @param bubble_plot_data list of center points, lower and upper tangential 
#' points (each a n x 2 data frame)
#' @param base_graph plot to add points to
#' @param color color of points
#' @param zoom map zoom for ggmap
#' @param ... Interior ggpath parameters
#'
#' @return ggplot object with points on it
ggvis_bubble_data_centers_inner <- function(bubble_plot_data, base_graph = NULL, 
                                         color = "pink", zoom = 4, ...){
  
  center <- data.frame(bubble_plot_data$center)
  names(center)[1:2] <- c("lat", "lon")
  
  if (is.null(base_graph)) {
    latrange <- range(center$lat)
    lonrange <- range(center$long)
    
    ocean <- c(left = lonrange[1], bottom = latrange[1],
               right = lonrange[2], top = latrange[2])
    map   <- ggmap::get_stamenmap(ocean, zoom = zoom, maptype = "toner-lite")
    
    base_graph <- ggmap::ggmap(map)
  } 
  
  ggout <- base_graph + 
    ggplot2::geom_point(data = center, ggplot2::aes_string(x = 'lat', y = 'lon'),
               color = color, ...)
  
  return(ggout)
}
